<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handlelister</title>
</head>
<body>
    <header>
        <button type="button" id="signup-button" data-dialog-open="signup-dialog">Registrer</button>
        <dialog closedby="any" id="signup-dialog">
            <form id="signup-form" action="/src/api/authentication/signup.php" method="post">
                <label>
                    E-post
                    <input type="email" required name="email">
                </label>
                <label>
                    Passord (minst 16 tegn)
                    <input type="password" required name="password" autocomplete="new-password" minlength="16">
                </label>
                <button type="button" class="dialog-close-button">Avbryt</button>
                <button type="submit">Registrer ny bruker</button>
            </form>
        </dialog>
        <button type="button" id="login-button" data-dialog-open="login-dialog">Logg inn</button>
        <dialog closedby="any" id="login-dialog">
            <form id="login-form" action="/src/api/authentication/login.php" method="post">
                <label>
                    E-post
                    <input type="email" required name="email">
                </label>
                <label>
                    Passord
                    <input type="password" required name="password" autocomplete="current-password">
                </label>
                <button type="button" class="dialog-close-button">Avbryt</button>
                <button type="submit">Logg inn</button>
            </form>
        </dialog>
    </header>
    <main>
        <ul id="shopping-lists-ul"></ul>
        <button type="button" id="new-shopping-list-button" data-dialog-open="new-shopping-list-dialog">Ny handleliste</button>
        <dialog closedby="any" id="new-shopping-list-dialog">
            <form id="new-shopping-list-form" action="/src/api/shoppinglist/index.php" method="post">
                <label>
                    Handleliste navn
                    <input type="text" required name="name">
                </label>
                <button type="button" class="dialog-close-button">Avbryt</button>
                <button type="submit">Opprett ny handleliste</button>
            </form>
        </dialog>
    </main>
    <script>
        const shoppinglistsUl = document.getElementById('shopping-lists-ul')
        const newShoppingListButton = document.getElementById('new-shopping-list-button')
        const signupButton = document.getElementById('signup-button')
        const loginButton = document.getElementById('login-button')
        const newShoppingListForm = document.getElementById('new-shopping-list-form')
        const signupForm = document.getElementById('signup-form')
        const loginForm = document.getElementById('login-form')

        async function submitFormWithJson(event) {
            event.preventDefault()

            const form = event.target
            const url = form.action
            const method = form.method

            const formData = new FormData(form)
            // Gets rid of any form controls that haven't been filled out.
            // Note: this also gets rid of form controls which have intentionally not been filled out.
            const filteredFormData = Object.fromEntries([...formData].filter(([key, value]) => value !== ''))
            const body = JSON.stringify(filteredFormData)

            const headers = {
                'Content-Type': 'application/json'
            }

            const response = await fetch(url, {
                method,
                body,
                headers,
            })

            return {
                response,
                result: await response.json(),
                formData: filteredFormData,
            }
        }

        function handleLoggedIn() {
            newShoppingListButton.hidden = false
            signupButton.hidden = true
            loginButton.hidden = true
        }

        function handleNotLoggedIn() {
            newShoppingListButton.hidden = true
            signupButton.hidden = false
            loginButton.hidden = false
        }

        function addShoppinglistToUI(shoppinglist) {
            const li = document.createElement('li')
            li.textContent = shoppinglist.name

            const deleteButton = document.createElement('button')
            deleteButton.type = 'button'
            deleteButton.textContent = 'X'
            deleteButton.ariaLabel = 'slett handleliste'

            deleteButton.addEventListener('click', async () => {
                const searchParams = new URLSearchParams({
                    id: shoppinglist.id
                })

                const response = await fetch(`/src/api/shoppinglist/index.php?${searchParams}`, {
                    method: 'DELETE'
                })

                const result = await response.json()

                if (result.success) {
                    li.remove()
                }
            })

            li.append(deleteButton)
            shoppinglistsUl.append(li)
        }

        async function fetchShoppingLists() {
            const response = await fetch('/src/api/shoppinglist/index.php')
            const result = await response.json()

            const isLoggedIn = result.success === true && response.status !== 401

            newShoppingListButton.hidden = !isLoggedIn
            signupButton.hidden = isLoggedIn
            loginButton.hidden = isLoggedIn

            if (!isLoggedIn) {return}

            const shoppinglists = result.data

            if (shoppinglists.length === 0) {

                return
            }

            shoppinglists.innerHTML = '';
            shoppinglists.forEach(addShoppinglistToUI)
        }

        fetchShoppingLists()

        newShoppingListForm.addEventListener('submit', async event => {
            const {result, formData} = await submitFormWithJson(event)

            if (result.success) {
                event.target.closest('dialog').close()

                addShoppinglistToUI({
                    id: result.data.id,
                    name: formData.name,
                })
            }
        })

        signupForm.addEventListener('submit', submitFormWithJson)

        loginForm.addEventListener('submit', async event => {
            const {result} = await submitFormWithJson(event)

            if (result.success) {
                event.target.closest('dialog').close()

                fetchShoppingLists()
            }
        })

        const dialogOpenButtons = document.querySelectorAll('[data-dialog-open]')

        dialogOpenButtons.forEach(dialogOpenButton => {
            dialogOpenButton.addEventListener('click', () => {
                const dialogId = dialogOpenButton.dataset.dialogOpen
                const dialog = document.getElementById(dialogId)

                dialog.showModal()
            })
        })

        const dialogCloseButtons = document.querySelectorAll('.dialog-close-button')

        dialogCloseButtons.forEach(dialogCloseButton => {
            dialogCloseButton.addEventListener('click', () => {
                const dialog = dialogCloseButton.closest('dialog')

                dialog.close()
            })
        })
    </script>
</body>
</html>