<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handlelister</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="breadcrumbs">Handlelister</div>
        <button type="button" id="signup-button" data-dialog-open="signup-dialog">Registrer</button>
        <dialog closedby="any" id="signup-dialog">
            <form id="signup-form" action="/src/api/authentication/signup.php" method="post">
                <label>
                    E-post
                    <input type="email" required name="email">
                </label>
                <label>
                    Passord (minst 16 tegn)
                    <input type="password" required name="password" autocomplete="new-password" minlength="16">
                </label>
                <div class="form-buttons">
                    <button type="button" class="dialog-close-button">Avbryt</button>
                    <button type="submit">Registrer ny bruker</button>
                </div>
            </form>
        </dialog>
        <button type="button" id="login-button" data-dialog-open="login-dialog">Logg inn</button>
        <dialog closedby="any" id="login-dialog">
            <form id="login-form" action="/src/api/authentication/login.php" method="post">
                <label>
                    E-post
                    <input type="email" required name="email">
                </label>
                <label>
                    Passord
                    <input type="password" required name="password" autocomplete="current-password">
                </label>
                <div class="form-buttons">
                    <button type="button" class="dialog-close-button">Avbryt</button>
                    <button type="submit">Logg inn</button>
                </div>
            </form>
        </dialog>
        <button type="button" id="signout-button">Logg ut</button>
        <button type="button" id="edit-mode-button">Rediger</button>
    </header>
    <main>
        <ul id="shopping-lists-ul"></ul>
        <button type="button" id="new-shopping-list-button" data-dialog-open="new-shopping-list-dialog" class="full-width-button">Ny handleliste</button>
        <dialog closedby="any" id="new-shopping-list-dialog">
            <form id="new-shopping-list-form" action="/src/api/shopping-list/index.php" method="post">
                <label>
                    Handleliste navn
                    <input type="text" required name="name">
                </label>
                <div class="form-buttons">
                    <button type="button" class="dialog-close-button">Avbryt</button>
                    <button type="submit">Opprett ny handleliste</button>
                </div>
            </form>
        </dialog>
    </main>
    <script>
        const shoppingListsUl = document.getElementById('shopping-lists-ul')
        const newShoppingListButton = document.getElementById('new-shopping-list-button')
        const signupButton = document.getElementById('signup-button')
        const loginButton = document.getElementById('login-button')
        const signoutButton = document.getElementById('signout-button')
        const editModeButton = document.getElementById('edit-mode-button')
        const newShoppingListForm = document.getElementById('new-shopping-list-form')
        const signupForm = document.getElementById('signup-form')
        const loginForm = document.getElementById('login-form')

        async function submitFormWithJson(event) {
            event.preventDefault()

            const form = event.target
            const url = form.action
            const method = form.method

            const formData = new FormData(form)
            // Gets rid of any form controls that haven't been filled out.
            // Note: this also gets rid of form controls which have intentionally not been filled out.
            const filteredFormData = Object.fromEntries([...formData].filter(([key, value]) => value !== ''))
            const body = JSON.stringify(filteredFormData)

            const headers = {
                'Content-Type': 'application/json'
            }

            const response = await fetch(url, {
                method,
                body,
                headers,
            })

            return {
                response,
                result: await response.json(),
                formData: filteredFormData,
            }
        }

        function handleLoggedIn() {
            newShoppingListButton.hidden = false
            signupButton.hidden = true
            loginButton.hidden = true
            signoutButton.hidden = false
            editModeButton.hidden = false
        }

        function handleNotLoggedIn() {
            newShoppingListButton.hidden = true
            signupButton.hidden = false
            loginButton.hidden = false
            signoutButton.hidden = true
            editModeButton.hidden = true
            shoppingListsUl.innerHTML = '';
        }

        function addShoppinglistToUI(shoppingList) {
            const li = document.createElement('li')
            li.dataset.id = shoppingList.id

            const searchParams = new URLSearchParams({
                id: shoppingList.id
            })

            const nameAnchor = document.createElement('a')
            nameAnchor.classList.add('edit-mode-inactive')
            nameAnchor.href = `/public/shopping-list/index.html?${searchParams}`
            nameAnchor.textContent = shoppingList.name

            const editNameInput = document.createElement('input')
            editNameInput.classList.add('edit-mode-active')
            editNameInput.type = 'text'
            editNameInput.required = true
            editNameInput.name = `name`
            editNameInput.defaultValue = shoppingList.name

            editNameInput.addEventListener('change', async () => {
                const name = editNameInput.value

                const response = await fetch(`/src/api/shopping-list/index.php?${searchParams}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name
                    }),
                })

                const result = await response.json()

                if (result.success) {
                    nameAnchor.textContent = name
                }
            })

            const moveUpButton = document.createElement('button')
            moveUpButton.classList.add('edit-mode-active')
            moveUpButton.classList.add('button-icon')
            moveUpButton.type = 'button'
            moveUpButton.textContent = 'ðŸ¡…'
            moveUpButton.ariaLabel = 'flytt opp handleliste'

            moveUpButton.addEventListener('click', async () => {
                const ids = [...shoppingListsUl.querySelectorAll('li')].map(li => Number(li.dataset.id))
                const indexOfId = ids.indexOf(shoppingList.id)

                if (indexOfId === -1 || indexOfId === 0) {return}

                ;[ids[indexOfId], ids[indexOfId - 1]] = [ids[indexOfId - 1], ids[indexOfId]]

                const response = await fetch(`/src/api/shopping-list/order/index.php`, {
                    method: 'PATCH',
                    body: JSON.stringify(ids)
                })

                const result = await response.json()

                if (result.success) {
                    li.previousElementSibling.before(li)
                }
            })

            const moveDownButton = document.createElement('button')
            moveDownButton.classList.add('edit-mode-active')
            moveDownButton.classList.add('button-icon')
            moveDownButton.type = 'button'
            moveDownButton.textContent = 'ðŸ¡‡'
            moveDownButton.ariaLabel = 'flytt ned handleliste'

            moveDownButton.addEventListener('click', async () => {
                const ids = [...shoppingListsUl.querySelectorAll('li')].map(li => Number(li.dataset.id))
                const indexOfId = ids.indexOf(shoppingList.id)

                if (indexOfId === -1 || indexOfId === ids.length - 1) {return}

                ;[ids[indexOfId], ids[indexOfId + 1]] = [ids[indexOfId + 1], ids[indexOfId]]

                const response = await fetch(`/src/api/shopping-list/order/index.php`, {
                    method: 'PATCH',
                    body: JSON.stringify(ids)
                })

                const result = await response.json()

                if (result.success) {
                    li.nextElementSibling.after(li)
                }
            })

            const deleteButton = document.createElement('button')
            deleteButton.classList.add('edit-mode-active')
            deleteButton.classList.add('button-icon')
            deleteButton.type = 'button'
            deleteButton.textContent = 'âœ–'
            deleteButton.ariaLabel = 'slett handleliste'

            deleteButton.addEventListener('click', async () => {
                const response = await fetch(`/src/api/shopping-list/index.php?${searchParams}`, {
                    method: 'DELETE'
                })

                const result = await response.json()

                if (result.success) {
                    li.remove()
                }
            })

            li.append(nameAnchor, editNameInput, moveUpButton, moveDownButton, deleteButton)
            shoppingListsUl.append(li)
        }

        async function fetchShoppingLists() {
            const response = await fetch('/src/api/shopping-list/index.php')
            const result = await response.json()

            if (!result.success && response.status === 401) {
                handleNotLoggedIn()
                return
            }

            handleLoggedIn()

            const shoppingLists = result.data

            if (shoppingLists.length === 0) {

                return
            }

            shoppingListsUl.innerHTML = '';
            shoppingLists.forEach(addShoppinglistToUI)
        }

        fetchShoppingLists()

        newShoppingListForm.addEventListener('submit', async event => {
            const {result, formData} = await submitFormWithJson(event)

            if (result.success) {
                event.target.closest('dialog').close()
                event.target.reset()

                addShoppinglistToUI({
                    id: result.data.id,
                    name: formData.name,
                })
            }
        })

        signupForm.addEventListener('submit', submitFormWithJson)

        loginForm.addEventListener('submit', async event => {
            const {result} = await submitFormWithJson(event)

            if (result.success) {
                event.target.closest('dialog').close()
                event.target.reset()

                fetchShoppingLists()
            }
        })

        signoutButton.addEventListener('click', async () => {
            const response = await fetch('/src/api/authentication/signout.php')
            const result = await response.json()

            if (result.success) {
                handleNotLoggedIn()
            }
        })

        const dialogOpenButtons = document.querySelectorAll('[data-dialog-open]')

        dialogOpenButtons.forEach(dialogOpenButton => {
            dialogOpenButton.addEventListener('click', () => {
                const dialogId = dialogOpenButton.dataset.dialogOpen
                const dialog = document.getElementById(dialogId)

                dialog.showModal()
            })
        })

        const dialogCloseButtons = document.querySelectorAll('.dialog-close-button')

        dialogCloseButtons.forEach(dialogCloseButton => {
            dialogCloseButton.addEventListener('click', () => {
                const dialog = dialogCloseButton.closest('dialog')

                dialog.close()
            })
        })

        let editModeActive = false

        function updateEditModeVisibility(target) {
            target.querySelectorAll('.edit-mode-active').forEach(element => {
                element.hidden = !editModeActive
            })

            target.querySelectorAll('.edit-mode-inactive').forEach(element => {
                element.hidden = editModeActive
            })
        }

        editModeButton.addEventListener('click', () => {
            editModeActive = !editModeActive

            updateEditModeVisibility(document)
        })

        updateEditModeVisibility(document)

        new MutationObserver((mutations, observer) => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(addedNode => {
                    if (addedNode.nodeType !== Node.ELEMENT_NODE) {return}

                    updateEditModeVisibility(addedNode)
                })
            })
        }).observe(document.body, {childList: true, subtree: true})
    </script>
</body>
</html>