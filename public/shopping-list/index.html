<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <header>
        <a href="/public/index.html">Handlelister</a>
        <button type="button" id="signout-button">Logg ut</button>
        <button type="button" id="edit-mode-button">Rediger</button>
    </header>
    <main>
        <ul id="shopping-list-items-ul"></ul>
        <button type="button" id="add-shopping-list-item-button" data-dialog-open="add-shopping-list-item-dialog">Legg til</button>
        <dialog closedby="any" id="add-shopping-list-item-dialog">
            <form id="add-shopping-list-item-form" method="post">
                <label>
                    Vare navn
                    <input type="text" required name="name">
                </label>
                <button type="button" class="dialog-close-button">Avbryt</button>
                <button type="submit">Legg til vare</button>
            </form>
        </dialog>
    </main>
    <script>
        const shoppingListItemsUl = document.getElementById('shopping-list-items-ul')
        const signoutButton = document.getElementById('signout-button')
        const editModeButton = document.getElementById('edit-mode-button')
        const addShoppinglistItemButton = document.getElementById('add-shopping-list-item-button')
        const addShoppinglistItemForm = document.getElementById('add-shopping-list-item-form')

        const windowSearchParams = new URLSearchParams(window.location.search)
        const shoppingListId = windowSearchParams.get('id')

        async function submitFormWithJson(event) {
            event.preventDefault()

            const form = event.target
            const url = form.action
            const method = form.method

            const formData = new FormData(form)
            // Gets rid of any form controls that haven't been filled out.
            // Note: this also gets rid of form controls which have intentionally not been filled out.
            const filteredFormData = Object.fromEntries([...formData].filter(([key, value]) => value !== ''))
            const body = JSON.stringify(filteredFormData)

            const headers = {
                'Content-Type': 'application/json'
            }

            const response = await fetch(url, {
                method,
                body,
                headers,
            })

            return {
                response,
                result: await response.json(),
                formData: filteredFormData,
            }
        }

        function handleNotLoggedIn() {
            window.location.href = '/public/index.html'
        }

        function addShoppinglistItemToUI(shoppingListItem) {
            const li = document.createElement('li')
            li.dataset.id = shoppingListItem.id

            const searchParams = new URLSearchParams({
                id: shoppingListItem.id
            })

            const nameButton = document.createElement('button')
            nameButton.classList.add('edit-mode-inactive')
            nameButton.classList.toggle('bought', shoppingListItem.bought)
            nameButton.type = 'button'
            nameButton.textContent = shoppingListItem.name

            nameButton.addEventListener('click', async () => {
                const bought = nameButton.classList.contains('bought')

                const response = await fetch(`/src/api/shopping-list/item/index.php?${searchParams}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bought: !bought
                    }),
                })

                const result = await response.json()

                if (result.success) {
                    nameButton.classList.toggle('bought')
                }
            })

            const editNameInput = document.createElement('input')
            editNameInput.classList.add('edit-mode-active')
            editNameInput.type = 'text'
            editNameInput.required = true
            editNameInput.name = `name`
            editNameInput.defaultValue = shoppingListItem.name

            editNameInput.addEventListener('change', async () => {
                const name = editNameInput.value

                const response = await fetch(`/src/api/shopping-list/item/index.php?${searchParams}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name
                    }),
                })

                const result = await response.json()

                if (result.success) {
                    nameButton.textContent = name
                }
            })

            const moveDownButton = document.createElement('button')
            moveDownButton.classList.add('edit-mode-active')
            moveDownButton.type = 'button'
            moveDownButton.textContent = 'V'
            moveDownButton.ariaLabel = 'flytt ned vare'

            moveDownButton.addEventListener('click', async () => {
                const ids = [...shoppingListItemsUl.querySelectorAll('li')].map(li => Number(li.dataset.id))
                const indexOfId = ids.indexOf(shoppingListItem.id)

                if (indexOfId === -1 || indexOfId === ids.length - 1) {return}

                ;[ids[indexOfId], ids[indexOfId + 1]] = [ids[indexOfId + 1], ids[indexOfId]]

                const response = await fetch(`/src/api/shopping-list/item/order/index.php`, {
                    method: 'PATCH',
                    body: JSON.stringify(ids)
                })

                const result = await response.json()

                if (result.success) {
                    li.nextElementSibling.after(li)
                }
            })

            const moveUpButton = document.createElement('button')
            moveUpButton.classList.add('edit-mode-active')
            moveUpButton.type = 'button'
            moveUpButton.textContent = 'A'
            moveUpButton.ariaLabel = 'flytt opp vare'

            moveUpButton.addEventListener('click', async () => {
                const ids = [...shoppingListItemsUl.querySelectorAll('li')].map(li => Number(li.dataset.id))
                const indexOfId = ids.indexOf(shoppingListItem.id)

                if (indexOfId === -1 || indexOfId === 0) {return}

                ;[ids[indexOfId], ids[indexOfId - 1]] = [ids[indexOfId - 1], ids[indexOfId]]

                const response = await fetch(`/src/api/shopping-list/item/order/index.php`, {
                    method: 'PATCH',
                    body: JSON.stringify(ids)
                })

                const result = await response.json()

                if (result.success) {
                    li.previousElementSibling.before(li)
                }
            })

            const deleteButton = document.createElement('button')
            deleteButton.classList.add('edit-mode-active')
            deleteButton.type = 'button'
            deleteButton.textContent = 'X'
            deleteButton.ariaLabel = 'fjern vare'

            deleteButton.addEventListener('click', async () => {
                const response = await fetch(`/src/api/shopping-list/item/index.php?${searchParams}`, {
                    method: 'DELETE'
                })

                const result = await response.json()

                if (result.success) {
                    li.remove()
                }
            })

            li.append(nameButton, editNameInput, moveDownButton, moveUpButton, deleteButton)
            shoppingListItemsUl.append(li)
        }

        async function fetchShoppingList() {
            const searchParams = new URLSearchParams({
                id: shoppingListId
            })

            const response = await fetch(`/src/api/shopping-list/index.php?${searchParams}`)
            const result = await response.json()

            if (!result.success && response.status === 401) {
                handleNotLoggedIn()
                return
            }

            const shoppingListName = result.data.name

            document.title = shoppingListName
            addShoppinglistItemForm.action = `/src/api/shopping-list/item/index.php?${searchParams}`
        }

        async function fetchShoppingListItems() {
            const searchParams = new URLSearchParams({
                id: shoppingListId
            })

            const response = await fetch(`/src/api/shopping-list/item/index.php?${searchParams}`)
            const result = await response.json()

            if (!result.success && response.status === 401) {
                handleNotLoggedIn()
                return
            }

            const shoppingListItems = result.data

            if (shoppingListItems.length === 0) {

                return
            }

            shoppingListItemsUl.innerHTML = '';
            shoppingListItems.forEach(addShoppinglistItemToUI)
        }

        fetchShoppingList().then(fetchShoppingListItems)

        addShoppinglistItemForm.addEventListener('submit', async event => {
            const {result, formData} = await submitFormWithJson(event)

            if (result.success) {
                event.target.closest('dialog').close()
                event.target.reset()

                addShoppinglistItemToUI({
                    id: result.data.id,
                    name: formData.name,
                })
            }
        })

        signoutButton.addEventListener('click', async () => {
            const response = await fetch('/src/api/authentication/signout.php')
            const result = await response.json()

            if (result.success) {
                handleNotLoggedIn()
            }
        })

        const dialogOpenButtons = document.querySelectorAll('[data-dialog-open]')

        dialogOpenButtons.forEach(dialogOpenButton => {
            dialogOpenButton.addEventListener('click', () => {
                const dialogId = dialogOpenButton.dataset.dialogOpen
                const dialog = document.getElementById(dialogId)

                dialog.showModal()
            })
        })

        const dialogCloseButtons = document.querySelectorAll('.dialog-close-button')

        dialogCloseButtons.forEach(dialogCloseButton => {
            dialogCloseButton.addEventListener('click', () => {
                const dialog = dialogCloseButton.closest('dialog')

                dialog.close()
            })
        })

        let editModeActive = false

        function updateEditModeVisibility(target) {
            target.querySelectorAll('.edit-mode-active').forEach(element => {
                element.hidden = !editModeActive
            })

            target.querySelectorAll('.edit-mode-inactive').forEach(element => {
                element.hidden = editModeActive
            })
        }

        editModeButton.addEventListener('click', () => {
            editModeActive = !editModeActive

            updateEditModeVisibility(document)
        })

        updateEditModeVisibility(document)

        new MutationObserver((mutations, observer) => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(addedNode => {
                    if (addedNode.nodeType !== Node.ELEMENT_NODE) {return}

                    updateEditModeVisibility(addedNode)
                })
            })
        }).observe(document.body, {childList: true, subtree: true})
    </script>
</body>
</html>